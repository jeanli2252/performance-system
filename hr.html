<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR é é¢ - ç¸¾æ•ˆç®¡ç†ç³»çµ±</title>
    <style>
        /* ===== 1. åŸºæœ¬è¨­å®š ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ===== 2. é ‚éƒ¨å°èˆªåˆ— ===== */
        .navbar {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-left h2 {
            color: #333;
            font-size: 20px;
        }

        .navbar-left p {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .navbar-right {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .export-btn {
            background: #28a745;
            color: white;
        }

        .export-btn:hover {
            background: #218838;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
        }

        .logout-btn:hover {
            background: #ee5a52;
        }

        /* ===== 3. ä¸»è¦å…§å®¹å®¹å™¨ ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ===== 4. å¡ç‰‡æ¨£å¼ ===== */
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h3 {
            color: #333;
            font-size: 22px;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        /* ===== 5. çµ±è¨ˆå¡ç‰‡ ===== */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-left: 5px solid #667eea;
        }

        .stat-card.success {
            border-left-color: #28a745;
        }

        .stat-card.warning {
            border-left-color: #ffc107;
        }

        .stat-card.info {
            border-left-color: #17a2b8;
        }

        .stat-card h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-card .percentage {
            font-size: 14px;
            color: #28a745;
        }

        /* ===== 6. éƒ¨é–€å¡ç‰‡ ===== */
        .departments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dept-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .dept-card h4 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .dept-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .dept-stat-item {
            text-align: center;
        }

        .dept-stat-item .label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .dept-stat-item .value {
            font-size: 24px;
            font-weight: bold;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.3);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.5s ease;
        }

        .dept-card .completion-text {
            font-size: 14px;
            text-align: right;
            opacity: 0.9;
        }

        /* ===== 7. ç¯©é¸å™¨ ===== */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        /* ===== 8. ç¸¾æ•ˆè¡¨æ ¼ ===== */
        .performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .performance-table th {
            background: #f5f5f5;
            padding: 15px 12px;
            text-align: left;
            font-size: 14px;
            color: #333;
            border-bottom: 2px solid #667eea;
            font-weight: bold;
        }

        .performance-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            color: #666;
        }

        .performance-table tr:hover {
            background: #f9f9f9;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .score-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 16px;
        }

        /* ===== 9. éŸ¿æ‡‰å¼è¨­è¨ˆ ===== */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }

            .navbar-right {
                width: 100%;
            }

            .navbar-right .btn {
                flex: 1;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .departments-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .performance-table {
                font-size: 12px;
            }

            .performance-table th,
            .performance-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆªåˆ— -->
    <div class="navbar">
        <div class="navbar-left">
            <h2>ğŸ“Š HR ç®¡ç†å¾Œå°</h2>
            <p id="welcomeMessage">æ­¡è¿å›ä¾†ï¼Œè¼‰å…¥ä¸­...</p>
        </div>
        <div class="navbar-right">
            <button class="btn export-btn" onclick="exportToSheet()">ğŸ“¥ åŒ¯å‡ºåˆ° Google Sheets</button>
            <button class="btn logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container">
        <!-- å…¨å…¬å¸çµ±è¨ˆ -->
        <div class="stats-container">
            <div class="stat-card">
                <h4>ç¸½å“¡å·¥æ•¸</h4>
                <div class="number" id="totalEmployees">0</div>
            </div>
            <div class="stat-card warning">
                <h4>å·²æäº¤è‡ªè©•</h4>
                <div class="number" id="submittedCount">0</div>
            </div>
            <div class="stat-card success">
                <h4>å·²å®Œæˆè©•åˆ†</h4>
                <div class="number" id="completedCount">0</div>
            </div>
            <div class="stat-card info">
                <h4>å®Œæˆç‡</h4>
                <div class="number" id="completionRate">0%</div>
            </div>
        </div>

        <!-- éƒ¨é–€ç¸¾æ•ˆç¸½è¦½ -->
        <div class="card">
            <h3>ğŸ¢ éƒ¨é–€ç¸¾æ•ˆç¸½è¦½</h3>
            <div class="departments-grid" id="departmentsGrid">
                <!-- é€™è£¡æœƒç”¨ JavaScript å‹•æ…‹å¡«å…¥è³‡æ–™ -->
            </div>
        </div>

        <!-- ç¸¾æ•ˆè¨˜éŒ„åˆ—è¡¨ -->
        <div class="card">
            <h3>ğŸ“‹ æ‰€æœ‰ç¸¾æ•ˆè¨˜éŒ„</h3>
            
            <!-- ç¯©é¸å™¨ -->
            <div class="filters">
                <div class="filter-group">
                    <label for="deptFilter">éƒ¨é–€ç¯©é¸</label>
                    <select id="deptFilter" onchange="filterPerformances()">
                        <option value="all">å…¨éƒ¨éƒ¨é–€</option>
                        <option value="æ¥­å‹™éƒ¨">æ¥­å‹™éƒ¨</option>
                        <option value="è¡ŒéŠ·éƒ¨">è¡ŒéŠ·éƒ¨</option>
                        <option value="æŠ€è¡“éƒ¨">æŠ€è¡“éƒ¨</option>
                        <option value="å®¢æœéƒ¨">å®¢æœéƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">ç‹€æ…‹ç¯©é¸</label>
                    <select id="statusFilter" onchange="filterPerformances()">
                        <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                        <option value="pending">å¾…è©•åˆ†</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                </div>
            </div>

            <!-- ç¸¾æ•ˆè¡¨æ ¼ -->
            <table class="performance-table">
                <thead>
                    <tr>
                        <th>å“¡å·¥</th>
                        <th>éƒ¨é–€</th>
                        <th>å­£åº¦</th>
                        <th>è‡ªè©•åˆ†æ•¸</th>
                        <th>ä¸»ç®¡è©•åˆ†</th>
                        <th>ç‹€æ…‹</th>
                        <th>æäº¤æ™‚é–“</th>
                    </tr>
                </thead>
                <tbody id="performanceTableBody">
                    <!-- é€™è£¡æœƒç”¨ JavaScript å‹•æ…‹å¡«å…¥è³‡æ–™ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ===== JavaScript éƒ¨åˆ† =====

        // æ‰€æœ‰å“¡å·¥è³‡æ–™ï¼ˆåŒ…å«éƒ¨é–€è³‡è¨Šï¼‰
        const allEmployees = {
            'wang': { name: 'ç‹å°æ˜', dept: 'æ¥­å‹™éƒ¨' },
            'lin': { name: 'æ—ç¾ç²', dept: 'æ¥­å‹™éƒ¨' },
            'chen_dm': { name: 'é™³å¤§æ˜', dept: 'æ¥­å‹™éƒ¨' },
            'huang': { name: 'é»ƒå°èŠ³', dept: 'è¡ŒéŠ·éƒ¨' },
            'wu': { name: 'å³å¿—æ˜', dept: 'è¡ŒéŠ·éƒ¨' },
            'zhang': { name: 'å¼µç¶“ç†', dept: 'æ¥­å‹™éƒ¨' },
            'liu': { name: 'åŠ‰ç¶“ç†', dept: 'è¡ŒéŠ·éƒ¨' }
        };

        // å„²å­˜æ‰€æœ‰ç¸¾æ•ˆè³‡æ–™ï¼ˆç”¨æ–¼ç¯©é¸ï¼‰
        let allPerformances = [];

        // 1. é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = function() {
            checkLogin();
            loadAllData();
        };

        // 2. æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        function checkLogin() {
            const currentUser = localStorage.getItem('currentUser');
            
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                window.location.href = 'index.html';
                return;
            }

            const user = JSON.parse(currentUser);
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯ HR
            if (user.role !== 'hr') {
                alert('æ­¤é é¢åƒ…ä¾› HR ä½¿ç”¨ï¼');
                window.location.href = 'index.html';
                return;
            }

            // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
            document.getElementById('welcomeMessage').textContent = 
                `æ­¡è¿å›ä¾†ï¼Œ${user.name}`;
        }

        // 3. è¼‰å…¥æ‰€æœ‰è³‡æ–™
        function loadAllData() {
            const performances = JSON.parse(localStorage.getItem('performances') || '[]');
            allPerformances = performances;

            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            const totalEmployees = Object.keys(allEmployees).filter(u => !u.includes('ç¶“ç†')).length;
            const submittedCount = performances.length;
            const completedCount = performances.filter(p => p.managerScore).length;
            const completionRate = totalEmployees > 0 
                ? Math.round((completedCount / totalEmployees) * 100) 
                : 0;

            // æ›´æ–°çµ±è¨ˆå¡ç‰‡
            document.getElementById('totalEmployees').textContent = totalEmployees;
            document.getElementById('submittedCount').textContent = submittedCount;
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('completionRate').textContent = completionRate + '%';

            // é¡¯ç¤ºéƒ¨é–€ç¸½è¦½
            displayDepartmentOverview(performances);

            // é¡¯ç¤ºç¸¾æ•ˆåˆ—è¡¨
            filterPerformances();
        }

        // 4. é¡¯ç¤ºéƒ¨é–€ç¸½è¦½
        function displayDepartmentOverview(performances) {
            const departments = ['æ¥­å‹™éƒ¨', 'è¡ŒéŠ·éƒ¨', 'æŠ€è¡“éƒ¨', 'å®¢æœéƒ¨'];
            const container = document.getElementById('departmentsGrid');

            container.innerHTML = departments.map(dept => {
                // è¨ˆç®—è©²éƒ¨é–€çš„å“¡å·¥æ•¸é‡
                const deptEmployees = Object.values(allEmployees).filter(e => e.dept === dept && !e.name.includes('ç¶“ç†'));
                const totalEmployees = deptEmployees.length;

                // è¨ˆç®—è©²éƒ¨é–€çš„ç¸¾æ•ˆæ•¸æ“š
                const deptPerformances = performances.filter(p => allEmployees[p.username]?.dept === dept);
                const submitted = deptPerformances.length;
                const completed = deptPerformances.filter(p => p.managerScore).length;
                const completionRate = totalEmployees > 0 
                    ? Math.round((completed / totalEmployees) * 100) 
                    : 0;

                // è¨ˆç®—å¹³å‡åˆ†æ•¸
                const completedPerfs = deptPerformances.filter(p => p.managerScore);
                const avgScore = completedPerfs.length > 0
                    ? (completedPerfs.reduce((sum, p) => sum + parseFloat(p.managerScore), 0) / completedPerfs.length).toFixed(1)
                    : 'N/A';

                return `
                    <div class="dept-card">
                        <h4>${dept}</h4>
                        <div class="dept-stats">
                            <div class="dept-stat-item">
                                <div class="label">å“¡å·¥æ•¸</div>
                                <div class="value">${totalEmployees}</div>
                            </div>
                            <div class="dept-stat-item">
                                <div class="label">å·²æäº¤</div>
                                <div class="value">${submitted}</div>
                            </div>
                            <div class="dept-stat-item">
                                <div class="label">å·²å®Œæˆ</div>
                                <div class="value">${completed}</div>
                            </div>
                            <div class="dept-stat-item">
                                <div class="label">å¹³å‡åˆ†</div>
                                <div class="value">${avgScore}</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${completionRate}%"></div>
                        </div>
                        <div class="completion-text">å®Œæˆç‡ï¼š${completionRate}%</div>
                    </div>
                `;
            }).join('');
        }

        // 5. ç¯©é¸ç¸¾æ•ˆè¨˜éŒ„
        function filterPerformances() {
            const deptFilter = document.getElementById('deptFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = [...allPerformances];

            // æŒ‰éƒ¨é–€ç¯©é¸
            if (deptFilter !== 'all') {
                filtered = filtered.filter(p => allEmployees[p.username]?.dept === deptFilter);
            }

            // æŒ‰ç‹€æ…‹ç¯©é¸
            if (statusFilter === 'pending') {
                filtered = filtered.filter(p => !p.managerScore);
            } else if (statusFilter === 'completed') {
                filtered = filtered.filter(p => p.managerScore);
            }

            // é¡¯ç¤ºè¡¨æ ¼
            displayPerformanceTable(filtered);
        }

        // 6. é¡¯ç¤ºç¸¾æ•ˆè¡¨æ ¼
        function displayPerformanceTable(performances) {
            const tbody = document.getElementById('performanceTableBody');

            if (performances.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-message">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç¸¾æ•ˆè¨˜éŒ„</td></tr>';
                return;
            }

            tbody.innerHTML = performances.map(p => {
                const employee = allEmployees[p.username];
                const status = p.managerScore ? 'completed' : 'pending';
                const statusText = p.managerScore ? 'å·²å®Œæˆ' : 'å¾…è©•åˆ†';
                const managerScore = p.managerScore || '-';

                return `
                    <tr>
                        <td>${employee.name}</td>
                        <td>${employee.dept}</td>
                        <td>${p.quarter}</td>
                        <td><span class="score-badge">${p.selfScore} åˆ†</span></td>
                        <td><span class="score-badge">${managerScore}${managerScore !== '-' ? ' åˆ†' : ''}</span></td>
                        <td><span class="status-badge status-${status}">${statusText}</span></td>
                        <td>${p.submitDate}</td>
                    </tr>
                `;
            }).join('');
        }

        // 7. åŒ¯å‡ºåˆ° Google Sheetsï¼ˆé ç•™åŠŸèƒ½ï¼‰
        function exportToSheet() {
            alert('ğŸ“¥ åŒ¯å‡ºåŠŸèƒ½å°‡åœ¨å¾Œç«¯ API å®Œæˆå¾Œå•Ÿç”¨ï¼\n\nå±†æ™‚å¯ä»¥å°‡æ‰€æœ‰ç¸¾æ•ˆè³‡æ–™åŒ¯å‡ºåˆ° Google Sheets é€²è¡Œé€²ä¸€æ­¥åˆ†æã€‚');
        }

        // 8. ç™»å‡ºåŠŸèƒ½
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>